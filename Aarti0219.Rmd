---
title: "Aarti0219"
author: "Haochen_Li"
date: "2025-02-19"
output: pdf_document
---

Reshaping the dataset

```{r}
library(tidyverse)
library(lme4)
library(car)
library(DHARMa)
library(MASS)
library(glmmTMB)
library(ordinal)
library(nnet)
library(lmtest)
library(caret)
```

```{r}
df <- read.csv("merge_fmt.csv")

# Reshape
pre_post_columns <- names(df)[grepl("_pre|_post", names(df))]
percentage_columns <- c("percentage_pre", "percentage_post")

# Convert to long format while keeping original variable names
df_long <- df %>%
  pivot_longer(
    cols = setdiff(pre_post_columns, percentage_columns),  # Exclude percentage columns from reshaping
    names_to = "Variable",
    values_to = "Value"
  ) %>%
  mutate(
    Time = ifelse(grepl("_pre$", Variable), 0, 1),  # Assign 0 for pre, 1 for post
    Variable = gsub("_pre|_post", "", Variable)  # Remove _pre and _post to keep original variable names
  ) %>%
  pivot_wider(names_from = Variable, values_from = Value)  # Spread variables back into wide format

# Retain percentage_pre and percentage_post while reshaping
df_long <- df_long %>%
  group_by(ID) %>%  # Ensure values are assigned correctly per ID
  mutate(
    percentage_pre = unique(percentage_pre, na.rm = TRUE),
    percentage_post = unique(percentage_post, na.rm = TRUE)
  ) %>%
  ungroup()

df_long$scievidence  <- factor(df_long$scievidence, ordered = TRUE)
df_long$scitools     <- factor(df_long$scitools, ordered = TRUE)
df_long$sciexplain   <- factor(df_long$sciexplain, ordered = TRUE)
df_long$ID <- as.factor(df_long$ID)
df_long$SCHOOL <- as.factor(df_long$SCHOOL)

df$scievidence_pre  <- factor(df$scievidence_pre, ordered = FALSE)
df$scitools_pre     <- factor(df$scitools_pre, ordered = FALSE)
df$sciexplain_pre   <- factor(df$sciexplain_pre, ordered = FALSE)
df$selfsciid_pre       <- factor(df$selfsciid_pre, ordered = FALSE)
df$session <- factor(df$session, ordered = FALSE)
df$percentage_post <- as.numeric(df$percentage_post)
```

(1) Kids' pre-existing conceptions of the nature of science (e.g. science is using microscopes) positively or negatively predict their post-test performance on the longer and shorter version of a challenging science curriculum

```{r}
library(lmerTest)

NUll_model_1 <- lmer(
  percentage_post ~
    (1 | SCHOOL) ,
  data = df
)

NUll_model_2 <- lmer(
  percentage_post ~
    (1 | SCHOOL/TEACHER),
  data = df
)

model_lmer <- lmer(
  percentage_post ~ scitools_pre + scievidence_pre + sciexplain_pre + selfsciid_pre + session +
    (1 | SCHOOL),
  data = df
)
#summary(NUll_model_1)
#summary(NUll_model_2)
summary(model_lmer, correlation=TRUE)
```

```{r}
plot(model_lmer, which = 1)
qqnorm(resid(model_lmer))
qqline(resid(model_lmer))
hist(resid(model_lmer), breaks = 30, main = "Histogram of Residuals")
sim_res <- simulateResiduals(model_lmer)
plot(sim_res)
testDispersion(sim_res)
```

Binomial Mixed Model

Not all students answered all 6 questions. One student might skip items and still end up with the same “percentage correct” as someone who attempted all. This can lead to misleading residual patterns in a linear model and underweight important differences

```{r}
model_binomial_1 <- glmer(
  cbind(count_right_post, count_answered_post - count_right_post) ~ 
    scitools_pre + scievidence_pre + sciexplain_pre + selfsciid_pre + session + mindset_comp_pre + othersciid_pre+
    (1 | SCHOOL),
  family = binomial(link = "logit"),
  data = df
)
#summary(model_binomial_1)

#drop insignificant
# model_binomial_2 <- glmer(
#   cbind(count_right_post, count_answered_post - count_right_post) ~ 
#     scitools_pre + scievidence_pre + sciexplain_pre + selfsciid_pre + session +
#     (1 | SCHOOL),
#   family = binomial(link = "logit"),
#   data = df
# )
# summary(model_binomial_2)

sim_res <- simulateResiduals(model_binomial_1)
plot(sim_res)
testDispersion(sim_res)
vif(model_binomial_1)
```

The scitools_pre predictor is also significant but with a negative estimate, suggesting a negative association. 

The scievidence_pre predictor does not show a significant effect. 

The session variable, indicating the shorter or longer curriculum, has a negative effect, implying that students in the shorter curriculum performed worse. 

The variance of the random effect (school) is relatively small, suggesting some but limited variation across schools. 

The DHARMa residual diagnostics reveal severe issues with dispersion and deviation, particularly in the first model, indicating poor model fit and a need for alternative modeling approaches.

```{r}
model_bb <- glmmTMB(
  cbind(count_right_post, count_answered_post - count_right_post) ~ 
        scitools_pre + scievidence_pre + sciexplain_pre + selfsciid_pre + session
 + (1 | SCHOOL),
  family = betabinomial(link = "logit"),
  data = df
)

#summary(model_bb)
sim_res <- simulateResiduals(model_bb)
plot(sim_res)
testDispersion(sim_res)
```

The result suggests that selfsciid_pre (self-science identity pre-test) is a significant predictor of post-test performance (p=0.0111).

Session (p=0.069) and scitools_pre (p=0.0698) show marginal significance, suggesting that the length of the curriculum and pre-existing science tool understanding might have some influence, but the effects are not strongly significant.

Other predictors, including scievidence_pre and sciexplain_pre, do not show a significant effect.

The model fit is acceptable, with an AIC of 1257.5 and no major overdispersion issues (dispersion test p=0.752), indicating that the model appropriately captures the variance in the data.

The DHARMa residual diagnostics confirm that there are no significant residual patterns, supporting the reliability of the model.

(2) Whether kids participation in a longer vs. shorter version of a challenging curriculum changes three general conceptions of science

```{r}
model_scitools <- ordinal::clmm(
  scitools ~ Time * session + (1 | ID) + (1 | SCHOOL), 
  data = df_long, 
  link = "logit",
  control = clmm.control(method = "nlminb")
)

model_scievidence <- ordinal::clmm(
  scievidence ~ Time * session + (1 | ID) + (1 | SCHOOL),
  data = df_long,
  link = "logit",
  control = clmm.control(method = "nlminb")
)
model_sciexplain <- ordinal::clmm(
  sciexplain ~ Time * session + (1 | ID) + (1 | SCHOOL),
  data = df_long,
  link = "logit",
  control = clmm.control(method = "nlminb")
)

summary(model_scitools)
summary(model_scievidence)
summary(model_sciexplain)
```

model_scitools: No significant effects were found, suggesting that students' conceptions of science tools did not change based on time (pre vs. post) or curriculum length.

model_scievidence: The length of the curriculum had a significant effect on students’ perceptions of scientific evidence (p = 0.0437). However, there was no evidence that students' perceptions changed over time (p = 0.1353).

model_sciexplain: No significant effects were found in this model. Students' perceptions of scientific explanations did not change over time, nor were they affected by the curriculum length.

```{r}
df_long_3cpt <- df_long %>%
  pivot_longer(cols = c(scitools, scievidence, sciexplain), 
               names_to = "Variable", 
               values_to = "Value")


ggplot(df_long_3cpt, aes(x = as.factor(Value), fill = Variable)) +
  geom_bar(position = "dodge") +
  facet_wrap(~ Variable, scales = "free_x") +
  labs(title = "Distribution of Scitools, Scievidence, and Sciexplain",
       x = "Category",
       y = "Count") +
  theme_minimal()

```


scitools
```{r}
model_npo <- clmm(
  scitools ~ Time * session + factor(scitools) + (1 | ID) + (1 | SCHOOL),
  data = df_long,
  link = "logit"
)
anova(model_scitools, model_npo)
VarCorr(model_scitools)
```
scievidence
```{r}
multinom__scievidence <- multinom(scievidence ~ Time * session, data = df_long)
lrtest(model_scievidence, multinom__scievidence)
VarCorr(model_scievidence)
```
sciexplain
```{r}
multinom__sciexplain <- multinom(sciexplain ~ Time * session, data = df_long)
lrtest(model_sciexplain, multinom__sciexplain)
VarCorr(model_sciexplain)
```
Model comparison

```{r}
model_scitools_noSchool <- clmm(
  scitools ~ Time * session + (1 | ID),
  data = df_long,
  link = "logit"
)
AIC(model_scitools, model_scitools_noSchool)

model_scievidence_noSchool <- clmm(
  scitools ~ Time * session + (1 | ID),
  data = df_long,
  link = "logit"
)
AIC(model_scievidence, model_scievidence_noSchool)

model_sciexplain_noSchool <- clmm(
  scitools ~ Time * session + (1 | ID),
  data = df_long,
  link = "logit"
)
AIC(model_sciexplain, model_sciexplain_noSchool)
```


refit using Bayesian ordinal regression models

scitools_stan

```{r}
# library(rstanarm)

scitools_stan <- stan_polr(scitools ~ Time * session, 
                        data = df_long, 
                        method = "logistic", 
                        prior = R2(0.2, obs = nrow(df_long)),  # Weakly informative prior
                        prior_counts = dirichlet(1)  # Prior for ordinal thresholds
)

summary(scitools_stan)
```

```{r}
library(performance)
library(loo)
library(ggplot2)
library(bayesplot)

loo_results <- loo(scitools_stan)
print(loo_results)

pp_check(scitools_stan, type = "bars")

mcmc_trace(as.matrix(scitools_stan))

mcmc_acf(as.matrix(scitools_stan))

mcmc_areas(as.matrix(scitools_stan), pars = c("Time", "session", "Time:session"))
```

sciexplain_stan
```{r}
sciexplain_stan <- stan_polr(sciexplain ~ Time * session, 
                        data = df_long, 
                        method = "logistic", 
                        prior = R2(0.2, obs = nrow(df_long),  # Weakly informative prior
                        prior_counts = dirichlet(1)  # Prior for ordinal thresholds
)

summary(sciexplain_stan)
```

```{r}
loo_results <- loo(sciexplain_stan)
print(loo_results)

pp_check(sciexplain_stan, type = "bars")

mcmc_trace(as.matrix(sciexplain_stan))

mcmc_acf(as.matrix(sciexplain_stan))

mcmc_areas(as.matrix(sciexplain_stan), pars = c("Time", "session", "Time:session"))
```

scievidence_stan
```{r}
scievidence_stan <- stan_polr(scievidence ~ Time * session, 
                        data = df_long, 
                        method = "logistic", 
                        prior = R2(0.2, obs = nrow(df_long),  # Weakly informative prior
                        prior_counts = dirichlet(1)  # Prior for ordinal thresholds
)
summary(scievidence_stan)
```

```{r}
loo_results <- loo(scievidence_stan)
print(loo_results)

pp_check(scievidence_stan, type = "bars")

mcmc_trace(as.matrix(scievidence_stan))

mcmc_acf(as.matrix(scievidence_stan))

mcmc_areas(as.matrix(scievidence_stan), pars = c("Time", "session", "Time:session"))
```

preprocess grouped

```{r}
df_long$scitools_grouped <- factor(ifelse(df_long$scitools %in% c(1, 2), "1_2", as.character(df_long$scitools)),
                                    levels = c("1_2", "3", "4"))
df_long$scievidence_grouped <- factor(ifelse(df_long$scievidence %in% c(1, 2), "1_2", as.character(df_long$scievidence)),
                                    levels = c("1_2", "3", "4"))
df_long$sciexplaine_grouped <- factor(ifelse(df_long$sciexplain %in% c(1, 2), "1_2", as.character(df_long$sciexplain)),
                                    levels = c("1_2", "3", "4"))
df_long$scitools_grouped <- factor(df_long$sciexplaine_grouped, ordered = TRUE)
df_long$scievidence_grouped <- factor(df_long$sciexplaine_grouped, ordered = TRUE)
df_long$sciexplaine_grouped <- factor(df_long$sciexplaine_grouped, ordered = TRUE)
```


```{r}
model_scitools_g <- ordinal::clmm(
  scitools_grouped ~ Time * session + (1 | ID) + (1 | SCHOOL), 
  data = df_long, 
  link = "logit",
  control = clmm.control(method = "nlminb")
)

model_scievidence_g <- ordinal::clmm(
  scievidence_grouped ~ Time * session + (1 | ID) + (1 | SCHOOL),
  data = df_long,
  link = "logit",
  control = clmm.control(method = "nlminb")
)
model_sciexplain_g <- ordinal::clmm(
  sciexplaine_grouped ~ Time * session + (1 | ID) + (1 | SCHOOL),
  data = df_long,
  link = "logit",
  control = clmm.control(method = "nlminb")
)

summary(model_scitools_g)
summary(model_scievidence_g)
summary(model_sciexplain_g)

##############brm
scitools_brms <- brm(
  scitools ~ Time * session + (1 | SCHOOL),
  data = df_long,
  family = cumulative(link = "logit"),  # Use logit instead of probit
  prior = c(set_prior("normal(0, 2)", class = "b")),
  chains = 4, iter = 2000,
  refresh = 0
)
scitools_brms_npo <- brm(
  scitools ~ mo(Time) * mo(session) + (1 | SCHOOL),
  data = df_long,
  family = cumulative(link = "logit"),
  prior = c(set_prior("normal(0, 2)", class = "b")),
  refresh = 0
)
##
scievidence_brms <- brm(
  scievidence ~ Time * session + (1 | SCHOOL),
  data = df_long,
  family = cumulative(link = "logit"),  # Use logit instead of probit
  prior = c(set_prior("normal(0, 2)", class = "b")),
  chains = 4, iter = 2000,
  refresh = 0
)
scievidence_brms_npo <- brm(
  scievidence ~ mo(Time) * mo(session) + (1 | SCHOOL),
  data = df_long,
  family = cumulative(link = "logit"),
  prior = c(set_prior("normal(0, 2)", class = "b")),
  refresh = 0
)
##
sciexplain_brms <- brm(
  sciexplain ~ Time * session + (1 | SCHOOL),
  data = df_long,
  family = cumulative(link = "logit"),  # Use logit instead of probit
  prior = c(set_prior("normal(0, 2)", class = "b")),
  chains = 4, iter = 2000,
  refresh = 0
)
sciexplain_brms_npo <- brm(
  sciexplain ~ mo(Time) * mo(session) + (1 | SCHOOL),
  data = df_long,
  family = cumulative(link = "logit"),
  prior = c(set_prior("normal(0, 2)", class = "b")),
  refresh = 0
)
## g
scitools_grouped_brms <- brm(
  scitools_grouped ~ Time * session + (1 | SCHOOL),
  data = df_long,
  family = cumulative(link = "logit"),  # Use logit instead of probit
  prior = c(set_prior("normal(0, 2)", class = "b")),
  chains = 4, iter = 2000,
  refresh = 0
)
scitools_grouped_brms_npo <- brm(
  scitools_grouped ~ mo(Time) * mo(session) + (1 | SCHOOL),
  data = df_long,
  family = cumulative(link = "logit"),
  prior = c(set_prior("normal(0, 2)", class = "b")),
  refresh = 0
)
##
scievidence_grouped_brms <- brm(
  scievidence_grouped ~ Time * session + (1 | SCHOOL),
  data = df_long,
  family = cumulative(link = "logit"),  # Use logit instead of probit
  prior = c(set_prior("normal(0, 2)", class = "b")),
  chains = 4, iter = 2000,
  refresh = 0
)
scievidence_grouped_brms_npo <- brm(
  scievidence_grouped ~ mo(Time) * mo(session) + (1 | SCHOOL),
  data = df_long,
  family = cumulative(link = "logit"),
  prior = c(set_prior("normal(0, 2)", class = "b")),
  refresh = 0
)
##
sciexplaine_grouped_brms <- brm(
  sciexplaine_grouped ~ Time * session + (1 | SCHOOL),
  data = df_long,
  family = cumulative(link = "logit"),  # Use logit instead of probit
  prior = c(set_prior("normal(0, 2)", class = "b")),
  chains = 4, iter = 2000,
  refresh = 0
)
sciexplaine_grouped_brms_npo <- brm(
  sciexplaine_grouped ~ mo(Time) * mo(session) + (1 | SCHOOL),
  data = df_long,
  family = cumulative(link = "logit"),
  prior = c(set_prior("normal(0, 2)", class = "b")),
  refresh = 0
)
summary(scitools_brms)
summary(scitools_brms_npo)
summary(scievidence_brms)
summary(scievidence_brms_npo)
summary(sciexplain_brms)
summary(sciexplain_brms_npo)

summary(scitools_grouped_brms)
summary(scitools_grouped_brms_npo)
summary(scievidence_grouped_brms)
summary(scievidence_grouped_brms_npo)
summary(sciexplaine_grouped_brms)
summary(sciexplaine_grouped_brms_npo)
```

```{r}
loo_results1 <- loo(model_scitools)
loo_results2 <- loo(model_scitools_g)

print(scitools_brms)
compare_models(scitools_brms, scitools_brms_npo)

pp_check(scitools_brms, type = "bars")

mcmc_trace(as.matrix(scitools_brms))

mcmc_acf(as.matrix(scitools_brms))

mcmc_areas(as.matrix(scitools_brms), pars = c("Time", "session", "Time:session"))

model_scitools_npo <- ordinal::clmm(
  scitools_grouped ~ Time * session + factor(scitools_grouped) * Time + factor(scitools_grouped) * session + (1 | ID) + (1 | SCHOOL), 
  data = df_long, 
  link = "logit",
  control = clmm.control(method = "nlminb")
)
model_scitools_npo <- ordinal::clmm(
  scitools_grouped ~ Time * session + factor(scitools_grouped) * Time + factor(scitools_grouped) * session + (1 | ID) + (1 | SCHOOL), 
  data = df_long, 
  link = "logit",
  control = clmm.control(method = "ucminf")  # Alternative optimizer
)

anova(model_scitools_npo, model_scitools_g)
```

```{r}
loo_results <- loo(scievidence_stan)
print(loo_results)

pp_check(scievidence_stan, type = "bars")

mcmc_trace(as.matrix(scievidence_stan))

mcmc_acf(as.matrix(scievidence_stan))

mcmc_areas(as.matrix(scievidence_stan), pars = c("Time", "session", "Time:session"))
```

